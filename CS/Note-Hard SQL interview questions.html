
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hard Data Analyst SQL Interview Questions &#8212; Study Notes</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script src="https://wavedrom.com/skins/default.js"></script>
    <script src="https://wavedrom.com/wavedrom.min.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Learning React" href="Note-Learning%20React.html" />
    <link rel="prev" title="HTML Basics" href="Note-HTML%20basics.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Study Notes</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   Study Notes Index (knowledge base structure)
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Statistics
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Book-Analysis%20of%20Observational%20Health%20Care%20Data%20Using%20SAS.html">
   [book] Analysis of Observational Health Care Data Using SAS
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Book-Causal_inference_in_statistics_a_primer.html">
   [book] Causal inference in statistics
   <em>
    a primer
   </em>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Book-Data_Analysis_Using_Regression_and_Multilevel_Hierarchical_Models.html">
   [book] Data Analysis Using Regression and Multilevel/Hierarchical Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Book-Fundamentals%20of%20Clinical%20Trials%20%284th%20edition%29.html">
   [book] Fundamentals of Clinical Trials (4th edition)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Book-Group%20Sequential%20and%20Confirmatory%20Adaptive%20Designs%20in%20Clinical%20Trials.html">
   [book] Group Sequential and Confirmatory Adaptive Designs in Clinical Trials
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Book-Regression%20Modeling%20Strategies.html">
   [book] Regression Modeling Strategies
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Note-Adaptive%20Trial%20Design.html">
   Adaptive Clinical Trial Design
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Note-Analysis%20of%20Ordinal%20Outcome.html">
   Analysis of ordinal outcome
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Note-Analysis%20of%20Stratified%20Randomization%20Trial%20Data.html">
   Why analysis of stratified randomization trial data need to account for the stratification factors?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Note-Association%20vs.%20Prediction%20vs.%20Causation.html">
   Association vs. Prediction vs. Causation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Note-Baseline%20Adaptive%20Randomization.html">
   Baseline adaptive randomization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Note-Bayesian%20optimization.html">
   Exploring Bayesian Optimization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Note-Causal%20inference%20general.html">
   Causal Inference General Study Notes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Note-Competing_Risk_Regression.html">
   Competing risk models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Note-Correlated%20Data%20Analysis.html">
   Correlated/Longitudinal Data Analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Note-Cox_PH_model.html">
   ​Cox PH model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Note-Dirichlet%20process.html">
   Dirichlet process
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Note-FDA%20guidances%20for%20industry.html">
   Notes on FDA Guidances for Industry
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Note-Gaussian%20process.html">
   Gaussain Process
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Note-Group_Sequential_Trial_Design.html">
   Notes on Group Sequential Trial Design​
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Note-ICH%20guidelines.html">
   Notes on ICH guidelines​
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Note-MDD%20%26%20Effect%20size.html">
   Power,
   <strong>
    MDD
   </strong>
   /
   <strong>
    E
   </strong>
   (minimum detectable difference/effect), and
   <strong>
    Effect size
   </strong>
   in clinical trials
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Note-Meta-Analysis.html">
   Meta-analysis​
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Note-Missing%20data.html">
   Missing data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Note-Model%20comparison%20methods.html">
   Model comparison methods
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Note-Monte%20Carlo%20method.html">
   Monte Carlo Method
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Note-Multicolinearity.html">
   Multicolinearity
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Note-Multiplicity%20in%20Clinical%20Trials.html">
   Multiplicity in Clinical Trials
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Note-Non-inferiority%20equivalence%20superiority%20test.html">
   Non-inferiority/equivalence/superiority test basics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Note-Observational%20study%20design.html">
   Observational study design
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Note-Propensity%20score%20methods.html">
   Propensity Score Methods &amp; Implementation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Note-Quantile%20regression.html">
   Quantile regression
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Note-Sample_size_calculation_with_WMW_test.html">
   Sample size calculation for the Wilcoxon-Mann-Whitney test adjusting for ties
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats/Note-Survival_Analysis.html">
   Survival Analysis
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Statistical computing
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats_Comp/Note-How%20R%20searches%20and%20finds%20stuff.html">
   How R searches and finds stuff
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats_Comp/Note-R%20notes.html">
   R study notes/tips
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats_Comp/Note-googleVis.html">
   Google R package googleVis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Stats_Comp/Note-matplotlib.html">
   Notes on
   <code class="docutils literal notranslate">
    <span class="pre">
     matplotlib
    </span>
   </code>
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  DS/ML
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../DS_ML/Book-Hands-On%20Machine%20Learning%20with%20Scikit-Learn%20and%20TensorFlow.html">
   [book] Hands-On Machine Learning with Scikit-Learn and TensorFlow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../DS_ML/Book-Python%20Data%20Science%20Handbook.html">
   [book] Python Data Science Handbook
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../DS_ML/Note-Boosting.html">
   Boosting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../DS_ML/Note-Cluster%20analysis.html">
   Cluster analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../DS_ML/Note-Machine%20Learning%20%28General%29.html">
   ​Machine Learning (General)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../DS_ML/Note-Naive%20Bayes.html">
   Naive Bayes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../DS_ML/Note-Stochasitic%20Gradient%20Descent.html">
   Stochastic Gradient Decent (SGD)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../DS_ML/Note-Tree%2C%20Random%20Forest%20%28Bagging%29.html">
   Tree/Random Forest (Bagging)
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Computer science
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Note-HTML%20basics.html">
   HTML Basics
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Hard Data Analyst SQL Interview Questions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Note-Learning%20React.html">
   Learning React
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Note-Learning%20Rust.html">
   Learning Rust
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Note-SQL%20Study%20Notes.html">
   SQL study notes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Note-git%20and%20github.html">
   git and github
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Miscellaneous
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Miscellaneous/Miscellaneous%20Notes.html">
   Miscellaneous Study Notes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Miscellaneous/Phamaceutical%20development.html">
   Pharmacedutical development
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Miscellaneous/Sim-Coin%20flip.html">
   :bulb: Q: fair coin, # of flips to get two consecutive side (H or T)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Miscellaneous/Sim-Generate%20random%20number%20between%201%20to%207.html">
   Generate random number 1 to 7 using a fair dice
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/CS/Note-Hard SQL interview questions.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/askming/study_notes"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/askming/study_notes/issues/new?title=Issue%20on%20page%20%2FCS/Note-Hard SQL interview questions.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Hard Data Analyst SQL Interview Questions
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#background-motivation">
     Background &amp; Motivation
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#assumptions-how-to-use-this-guide">
     Assumptions &amp; How to use this guide
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tips-on-solving-difficult-sql-interview-questions">
     Tips on solving difficult SQL interview questions
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#acknowledgments-and-additional-resources">
     Acknowledgments and Additional Resources
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#please-note-that-these-questions-are-not-literal-copies-of-sql-interview-questions-i-have-encountered-while-interviewing-nor-were-they-interview-questions-used-at-a-company-i-have-worked-at-or-work-at">
     Please note that these questions are not literal copies of SQL interview questions I have encountered while interviewing nor were they interview questions used at a company I have worked at or work at.
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#self-join-practice-problems">
   Self-Join Practice Problems
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#mom-percent-change">
     1: MoM Percent Change
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tree-structure-labeling">
     2: Tree Structure Labeling
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#retained-users-per-month-multi-part">
     3: Retained Users Per Month (multi-part)
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#part-1">
       Part 1:
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#part-2">
       Part 2:
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#part-3">
       Part 3:
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#cumulative-sums">
     4: Cumulative Sums
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#rolling-averages">
     5: Rolling Averages
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#multiple-join-conditions">
     6: Multiple Join Conditions
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#window-function-practice-problems">
   Window Function Practice Problems
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-the-id-with-the-highest-value">
     1: Get the ID with the highest value
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#average-and-rank-with-a-window-function-multi-part">
     2: Average and rank with a window function (multi-part)
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id1">
       Part 1:
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id2">
       Part 2:
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#other-medium-hard-sql-practice-problems">
   Other Medium/Hard SQL Practice Problems
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#histograms">
     1: Histograms
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#cross-join-multi-part">
     2: CROSS JOIN (multi-part)
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id3">
       Part 1:
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id4">
       Part 2:
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#advancing-counting">
     3: Advancing Counting
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Hard Data Analyst SQL Interview Questions</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Hard Data Analyst SQL Interview Questions
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#background-motivation">
     Background &amp; Motivation
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#assumptions-how-to-use-this-guide">
     Assumptions &amp; How to use this guide
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tips-on-solving-difficult-sql-interview-questions">
     Tips on solving difficult SQL interview questions
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#acknowledgments-and-additional-resources">
     Acknowledgments and Additional Resources
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#please-note-that-these-questions-are-not-literal-copies-of-sql-interview-questions-i-have-encountered-while-interviewing-nor-were-they-interview-questions-used-at-a-company-i-have-worked-at-or-work-at">
     Please note that these questions are not literal copies of SQL interview questions I have encountered while interviewing nor were they interview questions used at a company I have worked at or work at.
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#self-join-practice-problems">
   Self-Join Practice Problems
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#mom-percent-change">
     1: MoM Percent Change
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tree-structure-labeling">
     2: Tree Structure Labeling
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#retained-users-per-month-multi-part">
     3: Retained Users Per Month (multi-part)
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#part-1">
       Part 1:
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#part-2">
       Part 2:
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#part-3">
       Part 3:
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#cumulative-sums">
     4: Cumulative Sums
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#rolling-averages">
     5: Rolling Averages
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#multiple-join-conditions">
     6: Multiple Join Conditions
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#window-function-practice-problems">
   Window Function Practice Problems
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-the-id-with-the-highest-value">
     1: Get the ID with the highest value
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#average-and-rank-with-a-window-function-multi-part">
     2: Average and rank with a window function (multi-part)
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id1">
       Part 1:
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id2">
       Part 2:
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#other-medium-hard-sql-practice-problems">
   Other Medium/Hard SQL Practice Problems
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#histograms">
     1: Histograms
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#cross-join-multi-part">
     2: CROSS JOIN (multi-part)
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id3">
       Part 1:
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id4">
       Part 2:
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#advancing-counting">
     3: Advancing Counting
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="hard-data-analyst-sql-interview-questions">
<h1><a class="reference external" href="https://quip.com/2gwZArKuWk7W">Hard Data Analyst SQL Interview Questions</a><a class="headerlink" href="#hard-data-analyst-sql-interview-questions" title="Permalink to this headline">¶</a></h1>
<p>By Zachary Thomas (<a class="reference external" href="mailto:zthomas&#46;nc&#37;&#52;&#48;gmail&#46;com">zthomas<span>&#46;</span>nc<span>&#64;</span>gmail<span>&#46;</span>com</a>, <a class="reference external" href="https://twitter.com/zach_i_thomas">Twitter</a>, <a class="reference external" href="https://www.linkedin.com/in/thomaszi/">LinkedIn</a>)</p>
<p><strong>Tip:</strong> See the Table of Contents (document outline) by hovering over the vertical line on the right side of the page</p>
<p><strong>Update:</strong> Thanks everyone for the support and feedback! See this discussion on this post on <a class="reference external" href="https://news.ycombinator.com/item?id=23053981">Hacker News</a>, <a class="reference external" href="https://www.linkedin.com/posts/thomaszi_the-best-medium-hard-data-analyst-sql-interview-activity-6662828341382516736-L5If">Linkedin</a>, Eric Weber’s <a class="reference external" href="https://www.linkedin.com/posts/eric-weber-060397b7_datascience-analytics-sql-activity-6663082042990952449-wuOK">Linkedin post</a></p>
<div class="section" id="background-motivation">
<h2>Background &amp; Motivation<a class="headerlink" href="#background-motivation" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>The first 70% of SQL is pretty straightforward but the remaining 30% can be pretty tricky.</p>
</div></blockquote>
<p>Between the fall of 2015 and the summer of 2019 I interviewed for data analyst and data scientists positions four separate times, getting to onsite interviews at over a dozen companies. After an interview in 2017 went poorly — mostly due to me floundering at the more difficult SQL questions they asked me — I started putting together a study guide of medium and hard SQL questions to better prepare and found it particularly useful during my 2019 interview cycle. Over the past year I have shared that guide with a couple of friends, and with the extra time on my hands due to the coronavirus pandemic, I have polished it up into this doc.</p>
<p>There are plenty of great beginner SQL guides out there. My favorites are Codecademy’s <a class="reference external" href="https://www.codecademy.com/learn/learn-sql">interactive SQL courses</a> and Zi Chong Kao’s <a class="reference external" href="https://selectstarsql.com/">Select Star SQL</a>. However, like I told a friend, while the first 70% of SQL is pretty straightforward, the remaining 30% can be pretty tricky. Data analyst and data scientist interview questions at technology companies often pull from that 30%.</p>
<p>Strangely, I have never really found a comprehensive source online for those medium-hard SQL questions, which is why I put together this guide.</p>
<p>Working through this guide should improve your performance on data analyst interviews. It should also make you better at your current and future job positions. Personally, I find some of the SQL patterns found in this doc useful for ETLs powering reporting tools featuring trends over time.</p>
<p>To be clear, data analyst and data scientist interviews consist of more than SQL questions. Other common topics include explaining past projects, A/B testing (I like <a class="reference external" href="https://www.udacity.com/course/ab-testing--ud257">Udacity’s course</a> on the subject), metric development and open-ended analytical problems. This <a class="reference external" href="https://qr.ae/pNrdGV">Quora answer</a> has Facebook’s product analyst interview guide circa 2017, which discusses this topic in more depth. That said, if improving your SQL skills can make your interviews less stressful than they already are, it could very well be worth your time.</p>
<p>In the future, I may transition this doc to a website like <a class="reference external" href="https://selectstarsql.com/">Select Star SQL</a> with an embedded SQL editor so that readers can write SQL statements to questions and get real-time feedback on their code. Another option could be adding these questions as problems on Leetcode. For the time being though I just wanted to publish this doc so that people could find it useful now.</p>
<p><strong>I would love to get your feedback on this doc. Please drop a note if you find this useful, have improvements/corrections, or encounter other good resources for medium/hard difficulty SQL questions.</strong></p>
</div>
<div class="section" id="assumptions-how-to-use-this-guide">
<h2>Assumptions &amp; How to use this guide<a class="headerlink" href="#assumptions-how-to-use-this-guide" title="Permalink to this headline">¶</a></h2>
<p>**Assumptions about SQL proficiency: **This guide assumes you have a working knowledge of SQL. You probably use it frequently at work already but want to sharpen your skills on topics like self-joins and window functions.</p>
<p><strong>How to use this guide:</strong> Since interviews usually utilize a whiteboard or a virtual (non-compiling) notepad, my recommendation is to get out a pencil and paper and write out your solutions to each part of the problem, and once complete compare your answers to the answer key. Or, complete these with a friend who can act as the interviewer!</p>
<ul class="simple">
<li><p>Small SQL syntax errors aren’t a big deal during whiteboard/notepad interviews. However, they can be distracting to the interviewer, so ideally practice reducing these so your logic shines through in the interview.</p></li>
<li><p>The answers I provide may not be the only way to successfully solve the question. Feel free to message with additional solutions and I can add them to this guide!</p></li>
</ul>
</div>
<div class="section" id="tips-on-solving-difficult-sql-interview-questions">
<h2>Tips on solving difficult SQL interview questions<a class="headerlink" href="#tips-on-solving-difficult-sql-interview-questions" title="Permalink to this headline">¶</a></h2>
<p>This advice mirrors typical code interview advice …</p>
<ol class="simple">
<li><p>Listen carefully to problem description, repeat back the crux of the problem to the interviewer</p></li>
<li><p>Spell out an edge case to demonstrate you actually understand problem (i.e. a row that <em>wouldn’t</em> be included in the output of the SQL you are about to sketch out)</p></li>
<li><p>(If the problem involves a self-join) For your own benefit sketch out what the self-join will look like — this will typically be at least three columns: a column of interest from the main table, the column to join from the main table, and the column to join from the secondary table</p>
<ol class="simple">
<li><p>Or, as you get more used to self-join problems, you can explain this step verbally</p></li>
</ol>
</li>
<li><p>Start writing SQL — err towards writing SQL versus trying to perfectly understand the problem. Verbalize your assumptions as you go so your interviewer can correct you if you go astray.</p></li>
</ol>
</div>
<div class="section" id="acknowledgments-and-additional-resources">
<h2>Acknowledgments and Additional Resources<a class="headerlink" href="#acknowledgments-and-additional-resources" title="Permalink to this headline">¶</a></h2>
<p>Some of the problems listed here are adapted from old Periscope blog posts (mostly written around 2014 by <a class="reference external" href="https://www.linkedin.com/in/seangcook/">Sean Cook</a>, although his authorship seems to have been removed from the posts following SiSense’s <a class="reference external" href="https://www.sisense.com/blog/sisense-and-periscope-data-merge-2/">merger with</a> Periscope) or discussions from Stack Overflow; I’ve noted them at the start of questions as appropriate.</p>
<p><a class="reference external" href="https://selectstarsql.com/">Select Star SQL</a> has good<a class="reference external" href="https://selectstarsql.com/questions.html#challenge_questions">challenge questions</a> that are complementary to the questions in this doc.</p>
</div>
<div class="section" id="please-note-that-these-questions-are-not-literal-copies-of-sql-interview-questions-i-have-encountered-while-interviewing-nor-were-they-interview-questions-used-at-a-company-i-have-worked-at-or-work-at">
<h2>Please note that these questions are not literal copies of SQL interview questions I have encountered while interviewing nor were they interview questions used at a company I have worked at or work at.<a class="headerlink" href="#please-note-that-these-questions-are-not-literal-copies-of-sql-interview-questions-i-have-encountered-while-interviewing-nor-were-they-interview-questions-used-at-a-company-i-have-worked-at-or-work-at" title="Permalink to this headline">¶</a></h2>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="self-join-practice-problems">
<h1>Self-Join Practice Problems<a class="headerlink" href="#self-join-practice-problems" title="Permalink to this headline">¶</a></h1>
<div class="section" id="mom-percent-change">
<h2>1: MoM Percent Change<a class="headerlink" href="#mom-percent-change" title="Permalink to this headline">¶</a></h2>
<p><strong>Context:</strong> Oftentimes it’s useful to know how much a key metric, such as monthly active users, changes between months. Say we have a table <code class="docutils literal notranslate"><span class="pre">logins</span></code> in the form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">|</span> <span class="n">user_id</span> <span class="o">|</span> <span class="n">date</span>       <span class="o">|</span>
<span class="o">|---------|------------|</span>
<span class="o">|</span> <span class="mi">1</span>       <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">234</span>     <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">02</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">02</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">1</span>       <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">02</span> <span class="o">|</span>
<span class="o">|</span> <span class="o">...</span>     <span class="o">|</span> <span class="o">...</span>        <span class="o">|</span>
<span class="o">|</span> <span class="mi">234</span>     <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">04</span> <span class="o">|</span>
</pre></div>
</div>
<p><strong>Task</strong>: Find the month-over-month percentage change for monthly active users (MAU).</p>
<hr class="docutils" />
<p><em><strong>Solution:</strong></em></p>
<p><em>(This solution, like other solution code blocks you will see in this doc, contains comments about SQL syntax that may differ between flavors of SQL or other comments about the solutions as listed)</em></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>WITH mau AS 
(
  SELECT 
   /* 
    * Typically, interviewers allow you to write psuedocode for date functions 
    * i.e. will NOT be checking if you have memorized date functions. 
    * Just explain what your function does as you whiteboard 
    *
    * DATE_TRUNC() is available in Postgres, but other SQL date functions or 
    * combinations of date functions can give you a identical results   
    * See https://www.postgresql.org/docs/9.0/functions-datetime.html#FUNCTIONS-DATETIME-TRUNC
    */ 
    DATE_TRUNC(&#39;month&#39;, date) month_timestamp,
    COUNT(DISTINCT user_id) mau
  FROM 
    logins 
  GROUP BY 
    DATE_TRUNC(&#39;month&#39;, date)
  )
 
 SELECT 
    /*
    * You don&#39;t literally need to include the previous month in this SELECT statement. 
    * 
    * However, as mentioned in the &quot;Tips&quot; section of this guide, it can be helpful 
    * to at least sketch out self-joins to avoid getting confused which table 
    * represents the prior month vs current month, etc. 
    */ 
    a.month_timestamp previous_month, 
    a.mau previous_mau, 
    b.month_timestamp current_month, 
    b.mau current_mau, 
    ROUND(100.0*(b.mau - a.mau)/a.mau,2) AS percent_change 
 FROM
    mau a 
 JOIN 
    /*
    * Could also have done `ON b.month_timestamp = a.month_timestamp + interval &#39;1 month&#39;` 
    */
    mau b ON a.month_timestamp = b.month_timestamp - interval &#39;1 month&#39; 
  
</pre></div>
</div>
</div>
<div class="section" id="tree-structure-labeling">
<h2>2: Tree Structure Labeling<a class="headerlink" href="#tree-structure-labeling" title="Permalink to this headline">¶</a></h2>
<p><strong>Context:</strong> Say you have a table <code class="docutils literal notranslate"><span class="pre">tree</span></code> with a column of nodes and a column corresponding parent nodes</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">node</span>   <span class="n">parent</span>
<span class="mi">1</span>       <span class="mi">2</span>
<span class="mi">2</span>       <span class="mi">5</span>
<span class="mi">3</span>       <span class="mi">5</span>
<span class="mi">4</span>       <span class="mi">3</span>
<span class="mi">5</span>       <span class="n">NULL</span> 
</pre></div>
</div>
<p><strong>Task:</strong> Write SQL such that we label each node as a “leaf”, “inner” or “Root” node, such that for the nodes above we get:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">node</span>    <span class="n">label</span>  
<span class="mi">1</span>       <span class="n">Leaf</span>
<span class="mi">2</span>       <span class="n">Inner</span>
<span class="mi">3</span>       <span class="n">Inner</span>
<span class="mi">4</span>       <span class="n">Leaf</span>
<span class="mi">5</span>       <span class="n">Root</span>
</pre></div>
</div>
<p>A solution which works for the above example will receive full credit, although you can receive extra credit for providing a solution that is generalizable to a tree of any depth (not just depth = 2, as is the case in the example above).</p>
<p>(Side note: <a class="reference external" href="http://ceadserv1.nku.edu/longa//classes/mat385_resources/docs/trees.html">this link</a> has more details on Tree data structure terminology. Not needed to solve the problem though!)</p>
<hr class="docutils" />
<p><em><strong>Solution:</strong></em></p>
<p>**Note: **This solution works for the example above with tree depth = 2, but is not generalizable beyond that.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">WITH</span> <span class="n">join_table</span> <span class="n">AS</span> 
<span class="p">(</span>
<span class="n">SELECT</span> 
    <span class="n">a</span><span class="o">.</span><span class="n">node</span> <span class="n">a_node</span><span class="p">,</span>
    <span class="n">a</span><span class="o">.</span><span class="n">parent</span> <span class="n">a_parent</span><span class="p">,</span>
    <span class="n">b</span><span class="o">.</span><span class="n">node</span> <span class="n">b_node</span><span class="p">,</span> 
    <span class="n">b</span><span class="o">.</span><span class="n">parent</span> <span class="n">b_parent</span>
 <span class="n">FROM</span>
    <span class="n">tree</span> <span class="n">a</span> 
 <span class="n">LEFT</span> <span class="n">JOIN</span> 
    <span class="n">tree</span> <span class="n">b</span> <span class="n">ON</span> <span class="n">a</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">node</span> 
 <span class="p">)</span>
 
 <span class="n">SELECT</span> 
    <span class="n">a_node</span> <span class="n">node</span><span class="p">,</span> 
    <span class="n">CASE</span> 
        <span class="n">WHEN</span> <span class="n">b_node</span> <span class="n">IS</span> <span class="n">NULL</span> <span class="ow">and</span> <span class="n">b_parent</span> <span class="n">IS</span> <span class="n">NULL</span> <span class="n">THEN</span> <span class="s1">&#39;Root&#39;</span>
        <span class="n">WHEN</span> <span class="n">b_node</span> <span class="n">IS</span> <span class="n">NOT</span> <span class="n">NULL</span> <span class="ow">and</span> <span class="n">b_parent</span> <span class="n">IS</span> <span class="n">NOT</span> <span class="n">NULL</span> <span class="n">THEN</span> <span class="s1">&#39;Leaf&#39;</span>        
        <span class="n">ELSE</span> <span class="s1">&#39;Inner&#39;</span> 
    <span class="n">END</span> <span class="n">AS</span> <span class="n">label</span> 
 <span class="n">FROM</span> 
    <span class="n">join_table</span> 
        
</pre></div>
</div>
<p>An alternate solution, that is generalizable to any tree depth:</p>
<p><strong>Acknowledgement:</strong> this more generalizable solution was contributed by Fabian Hofmann on 5/2/20. Thank, FH!</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">WITH</span> <span class="n">join_table</span> <span class="n">AS</span>
<span class="p">(</span>
    <span class="n">SELECT</span> 
        <span class="n">cur</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> 
        <span class="n">cur</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> 
        <span class="n">COUNT</span><span class="p">(</span><span class="nb">next</span><span class="o">.</span><span class="n">node</span><span class="p">)</span> <span class="n">AS</span> <span class="n">num_children</span>
    <span class="n">FROM</span> 
        <span class="n">tree</span> <span class="n">cur</span>
    <span class="n">LEFT</span> <span class="n">JOIN</span> 
        <span class="n">tree</span> <span class="nb">next</span> <span class="n">ON</span> <span class="p">(</span><span class="nb">next</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
    <span class="n">GROUP</span> <span class="n">BY</span> 
        <span class="n">cur</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> 
        <span class="n">cur</span><span class="o">.</span><span class="n">parent</span>
<span class="p">)</span>

<span class="n">SELECT</span>
    <span class="n">node</span><span class="p">,</span>
    <span class="n">CASE</span>
        <span class="n">WHEN</span> <span class="n">parent</span> <span class="n">IS</span> <span class="n">NULL</span> <span class="n">THEN</span> <span class="s2">&quot;Root&quot;</span>
        <span class="n">WHEN</span> <span class="n">num_children</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="s2">&quot;Leaf&quot;</span>
        <span class="n">ELSE</span> <span class="s2">&quot;Inner&quot;</span>
    <span class="n">END</span> <span class="n">AS</span> <span class="n">label</span>
<span class="n">FROM</span> 
    <span class="n">join_table</span> 
</pre></div>
</div>
<p>An alternate solution, without explicit joins:</p>
<p><strong>Acknowledgement:</strong> William Chargin on 5/2/20 noted that <code class="docutils literal notranslate"><span class="pre">WHERE</span> <span class="pre">parent</span> <span class="pre">IS</span> <span class="pre">NOT</span> <span class="pre">NULL</span></code>  is needed to make this solution return <code class="docutils literal notranslate"><span class="pre">Leaf</span></code> instead of <code class="docutils literal notranslate"><span class="pre">NULL</span></code>. Thanks, WC!</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> 
    <span class="n">node</span><span class="p">,</span>
    <span class="n">CASE</span> 
        <span class="n">WHEN</span> <span class="n">parent</span> <span class="n">IS</span> <span class="n">NULL</span> <span class="n">THEN</span> <span class="s1">&#39;Root&#39;</span>
        <span class="n">WHEN</span> <span class="n">node</span> <span class="n">NOT</span> <span class="n">IN</span> 
            <span class="p">(</span><span class="n">SELECT</span> <span class="n">parent</span> <span class="n">FROM</span> <span class="n">tree</span> <span class="n">WHERE</span> <span class="n">parent</span> <span class="n">IS</span> <span class="n">NOT</span> <span class="n">NULL</span><span class="p">)</span> <span class="n">THEN</span> <span class="s1">&#39;Leaf&#39;</span>
        <span class="n">WHEN</span> <span class="n">node</span> <span class="n">IN</span> <span class="p">(</span><span class="n">SELECT</span> <span class="n">parent</span> <span class="n">FROM</span> <span class="n">tree</span><span class="p">)</span> <span class="n">AND</span> <span class="n">parent</span> <span class="n">IS</span> <span class="n">NOT</span> <span class="n">NULL</span> <span class="n">THEN</span> <span class="s1">&#39;Inner&#39;</span>
    <span class="n">END</span> <span class="n">AS</span> <span class="n">label</span> 
 <span class="kn">from</span> 
    <span class="nn">tree</span>
</pre></div>
</div>
</div>
<div class="section" id="retained-users-per-month-multi-part">
<h2>3: Retained Users Per Month (multi-part)<a class="headerlink" href="#retained-users-per-month-multi-part" title="Permalink to this headline">¶</a></h2>
<p>**Acknowledgement: **this problem is adapted from SiSense’s <a class="reference external" href="https://www.sisense.com/blog/use-self-joins-to-calculate-your-retention-churn-and-reactivation-metrics/">“Using Self Joins to Calculate Your Retention, Churn, and Reactivation Metrics”</a> blog post</p>
<div class="section" id="part-1">
<h3>Part 1:<a class="headerlink" href="#part-1" title="Permalink to this headline">¶</a></h3>
<p><strong>Context:</strong> Say we have login data in the table <code class="docutils literal notranslate"><span class="pre">logins</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">|</span> <span class="n">user_id</span> <span class="o">|</span> <span class="n">date</span>       <span class="o">|</span>
<span class="o">|---------|------------|</span>
<span class="o">|</span> <span class="mi">1</span>       <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">01</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">234</span>     <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">02</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">02</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">1</span>       <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">02</span> <span class="o">|</span>
<span class="o">|</span> <span class="o">...</span>     <span class="o">|</span> <span class="o">...</span>        <span class="o">|</span>
<span class="o">|</span> <span class="mi">234</span>     <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">04</span> <span class="o">|</span>
</pre></div>
</div>
<p><strong>Task:</strong> Write a query that gets the number of retained users per month. In this case, retention for a given month is defined as the number of users who logged in that month who also logged in the immediately previous month.</p>
<hr class="docutils" />
<p><em><strong>Solution:</strong></em></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> 
    <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">date</span><span class="p">)</span> <span class="n">month_timestamp</span><span class="p">,</span> 
    <span class="n">COUNT</span><span class="p">(</span><span class="n">DISTINCT</span> <span class="n">a</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span> <span class="n">retained_users</span> 
 <span class="n">FROM</span> 
    <span class="n">logins</span> <span class="n">a</span> 
 <span class="n">JOIN</span> 
    <span class="n">logins</span> <span class="n">b</span> <span class="n">ON</span> <span class="n">a</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">user_id</span> 
        <span class="n">AND</span> <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">date</span><span class="p">)</span> <span class="o">=</span> <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">date</span><span class="p">)</span> <span class="o">+</span> 
                                             <span class="n">interval</span> <span class="s1">&#39;1 month&#39;</span>
 <span class="n">GROUP</span> <span class="n">BY</span> 
    <span class="n">date_trunc</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
</pre></div>
</div>
<p>**Acknowledgement: **Tom Moertel pointed out de-duping user-login pairs before the self-join would make the solution more efficient and contributed the alternate solution below. Thanks, TM!</p>
<p>**Note: **De-duping <code class="docutils literal notranslate"><span class="pre">logins</span></code> would also make the given solutions to Parts 2 and 3 of this problem more efficient as well.</p>
<p>Alternate solution:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">WITH</span> <span class="n">DistinctMonthlyUsers</span> <span class="n">AS</span> <span class="p">(</span>
  <span class="o">/*</span>
  <span class="o">*</span> <span class="n">For</span> <span class="n">each</span> <span class="n">month</span><span class="p">,</span> <span class="n">compute</span> <span class="n">the</span> <span class="o">*</span><span class="nb">set</span><span class="o">*</span> <span class="n">of</span> <span class="n">users</span> <span class="n">having</span> <span class="n">logins</span><span class="o">.</span>
  <span class="o">*/</span>
    <span class="n">SELECT</span> <span class="n">DISTINCT</span>
      <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">&#39;MONTH&#39;</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span> <span class="n">AS</span> <span class="n">month_timestamp</span><span class="p">,</span>
      <span class="n">user_id</span>
    <span class="n">FROM</span> <span class="n">logins</span>
  <span class="p">)</span>

<span class="n">SELECT</span>
  <span class="n">CurrentMonth</span><span class="o">.</span><span class="n">month_timestamp</span> <span class="n">month_timestamp</span><span class="p">,</span>
  <span class="n">COUNT</span><span class="p">(</span><span class="n">PriorMonth</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span> <span class="n">AS</span> <span class="n">retained_user_count</span>
<span class="n">FROM</span> 
    <span class="n">DistinctMonthlyUsers</span> <span class="n">AS</span> <span class="n">CurrentMonth</span>
<span class="n">LEFT</span> <span class="n">JOIN</span> 
    <span class="n">DistinctMonthlyUsers</span> <span class="n">AS</span> <span class="n">PriorMonth</span>
  <span class="n">ON</span>
    <span class="n">CurrentMonth</span><span class="o">.</span><span class="n">month_timestamp</span> <span class="o">=</span> <span class="n">PriorMonth</span><span class="o">.</span><span class="n">month_timestamp</span> <span class="o">+</span> <span class="n">INTERVAL</span> <span class="s1">&#39;1 MONTH&#39;</span>
    <span class="n">AND</span> 
    <span class="n">CurrentMonth</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">PriorMonth</span><span class="o">.</span><span class="n">user_id</span>
</pre></div>
</div>
</div>
<div class="section" id="part-2">
<h3>Part 2:<a class="headerlink" href="#part-2" title="Permalink to this headline">¶</a></h3>
<p><strong>Task:</strong> Now we’ll take retention and turn it on its head: Write a query to find many users last month <em>did not</em> come back this month. i.e. the number of churned users.</p>
<hr class="docutils" />
<p><em><strong>Solution:</strong></em></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> 
    <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">date</span><span class="p">)</span> <span class="n">month_timestamp</span><span class="p">,</span> 
    <span class="n">COUNT</span><span class="p">(</span><span class="n">DISTINCT</span> <span class="n">b</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span> <span class="n">churned_users</span> 
<span class="n">FROM</span> 
    <span class="n">logins</span> <span class="n">a</span> 
<span class="n">FULL</span> <span class="n">OUTER</span> <span class="n">JOIN</span> 
    <span class="n">logins</span> <span class="n">b</span> <span class="n">ON</span> <span class="n">a</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">user_id</span> 
        <span class="n">AND</span> <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">date</span><span class="p">)</span> <span class="o">=</span> <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">date</span><span class="p">)</span> <span class="o">+</span> 
                                         <span class="n">interval</span> <span class="s1">&#39;1 month&#39;</span>
<span class="n">WHERE</span> 
    <span class="n">a</span><span class="o">.</span><span class="n">user_id</span> <span class="n">IS</span> <span class="n">NULL</span> 
<span class="n">GROUP</span> <span class="n">BY</span> 
    <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that there are solutions to this problem that can use <code class="docutils literal notranslate"><span class="pre">LEFT</span></code> or <code class="docutils literal notranslate"><span class="pre">RIGHT</span></code> joins.</p>
</div>
<div class="section" id="part-3">
<h3>Part 3:<a class="headerlink" href="#part-3" title="Permalink to this headline">¶</a></h3>
<p><strong>Context</strong>: You now want to see the number of active users this month <em>who have been reactivated</em> — in other words, users who have churned but this month they became active again. Keep in mind a user can reactivate after churning <em>before</em> the previous month. An example of this could be a user active in February (appears in <code class="docutils literal notranslate"><span class="pre">logins</span></code>), no activity in March and April, but then active again in May (appears in <code class="docutils literal notranslate"><span class="pre">logins</span></code>), so they count as a reactivated user for May .</p>
<p><strong>Task:</strong> Create a table that contains the number of reactivated users per month.</p>
<hr class="docutils" />
<p><em><strong>Solution:</strong></em></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>     <span class="n">SELECT</span> 
        <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">date</span><span class="p">)</span> <span class="n">month_timestamp</span><span class="p">,</span>
        <span class="n">COUNT</span><span class="p">(</span><span class="n">DISTINCT</span> <span class="n">a</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span> <span class="n">reactivated_users</span><span class="p">,</span>
        <span class="o">/*</span> 
        <span class="o">*</span> <span class="n">At</span> <span class="n">least</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">flavors</span> <span class="n">of</span> <span class="n">SQL</span> <span class="n">I</span> <span class="n">have</span> <span class="n">used</span><span class="p">,</span> <span class="n">you</span> <span class="n">don</span><span class="s1">&#39;t need to </span>
        <span class="o">*</span> <span class="n">include</span> <span class="n">the</span> <span class="n">columns</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">HAVING</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">SELECT</span> <span class="n">statement</span><span class="o">.</span>
        <span class="o">*</span> <span class="n">I</span> <span class="n">have</span> <span class="n">written</span> <span class="n">them</span> <span class="n">out</span> <span class="k">for</span> <span class="n">clarity</span> <span class="n">here</span><span class="o">.</span>  
        <span class="o">*/</span> 
        <span class="n">MAX</span><span class="p">(</span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">date</span><span class="p">))</span> <span class="n">most_recent_active_previously</span> 
     <span class="n">FROM</span> 
        <span class="n">logins</span> <span class="n">a</span>
     <span class="n">JOIN</span>
        <span class="n">logins</span> <span class="n">b</span> <span class="n">ON</span> <span class="n">a</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">user_id</span> 
                <span class="n">AND</span> 
                <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">date</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
     <span class="n">GROUP</span> <span class="n">BY</span> 
        <span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
     <span class="n">HAVING</span> 
        <span class="n">month_timestamp</span> <span class="o">&gt;</span> <span class="n">most_recent_active_previously</span> <span class="o">+</span> <span class="n">interval</span> <span class="s1">&#39;1 month&#39;</span> 
</pre></div>
</div>
</div>
</div>
<div class="section" id="cumulative-sums">
<h2>4: Cumulative Sums<a class="headerlink" href="#cumulative-sums" title="Permalink to this headline">¶</a></h2>
<p><strong>Acknowledgement:</strong> This problem was inspired by Sisense’s<a class="reference external" href="https://www.sisense.com/blog/cash-flow-modeling-in-sql/">“Cash Flow modeling in SQL”</a> blog post</p>
<p><strong>Context:</strong> Say we have a table <code class="docutils literal notranslate"><span class="pre">transactions</span></code> in the form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">|</span> <span class="n">date</span>       <span class="o">|</span> <span class="n">cash_flow</span> <span class="o">|</span>
<span class="o">|------------|-----------|</span>
<span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="o">|</span> <span class="o">-</span><span class="mi">1000</span>     <span class="o">|</span>
<span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span> <span class="o">|</span> <span class="o">-</span><span class="mi">100</span>      <span class="o">|</span>
<span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span> <span class="o">|</span> <span class="mi">50</span>        <span class="o">|</span>
<span class="o">|</span> <span class="o">...</span>        <span class="o">|</span> <span class="o">...</span>       <span class="o">|</span>
</pre></div>
</div>
<p>Where <code class="docutils literal notranslate"><span class="pre">cash_flow</span></code> is the revenues minus costs for each day.</p>
<p>**Task: **Write a query to get <em>cumulative</em> cash flow for each day such that we end up with a table in the form below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">|</span> <span class="n">date</span>       <span class="o">|</span> <span class="n">cumulative_cf</span> <span class="o">|</span>
<span class="o">|------------|---------------|</span>
<span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="o">|</span> <span class="o">-</span><span class="mi">1000</span>         <span class="o">|</span>
<span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span> <span class="o">|</span> <span class="o">-</span><span class="mi">1100</span>         <span class="o">|</span>
<span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span> <span class="o">|</span> <span class="o">-</span><span class="mi">1050</span>         <span class="o">|</span>
<span class="o">|</span> <span class="o">...</span>        <span class="o">|</span> <span class="o">...</span>           <span class="o">|</span>
</pre></div>
</div>
<hr class="docutils" />
<p><em><strong>Solution:</strong></em></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> 
    <span class="n">a</span><span class="o">.</span><span class="n">date</span> <span class="n">date</span><span class="p">,</span> 
    <span class="n">SUM</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">cash_flow</span><span class="p">)</span> <span class="k">as</span> <span class="n">cumulative_cf</span> 
<span class="n">FROM</span>
    <span class="n">transactions</span> <span class="n">a</span>
<span class="n">JOIN</span> <span class="n">b</span> 
    <span class="n">transactions</span> <span class="n">b</span> <span class="n">ON</span> <span class="n">a</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="n">b</span><span class="o">.</span><span class="n">date</span> 
<span class="n">GROUP</span> <span class="n">BY</span> 
    <span class="n">a</span><span class="o">.</span><span class="n">date</span> 
<span class="n">ORDER</span> <span class="n">BY</span> 
    <span class="n">date</span> <span class="n">ASC</span>
</pre></div>
</div>
<p>Alternate solution using a window function (more efficient!):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> 
    <span class="n">date</span><span class="p">,</span> 
    <span class="n">SUM</span><span class="p">(</span><span class="n">cash_flow</span><span class="p">)</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">ORDER</span> <span class="n">BY</span> <span class="n">date</span> <span class="n">ASC</span><span class="p">)</span> <span class="k">as</span> <span class="n">cumulative_cf</span> 
<span class="n">FROM</span>
    <span class="n">transactions</span> 
<span class="n">ORDER</span> <span class="n">BY</span> 
    <span class="n">date</span> <span class="n">ASC</span>
</pre></div>
</div>
</div>
<div class="section" id="rolling-averages">
<h2>5: Rolling Averages<a class="headerlink" href="#rolling-averages" title="Permalink to this headline">¶</a></h2>
<p><strong>Acknowledgement:</strong> This problem is adapted from Sisense’s <a class="reference external" href="https://www.sisense.com/blog/rolling-average/">“Rolling Averages in MySQL and SQL Server”</a> blog post</p>
<p><strong>Note:</strong> there are different ways to compute rolling/moving averages. Here we’ll use a preceding average which means that the metric for the 7th day of the month would be the average of the preceding 6 days and that day itself.</p>
<p><strong>Context</strong>: Say we have table <code class="docutils literal notranslate"><span class="pre">signups</span></code> in the form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">|</span> <span class="n">date</span>       <span class="o">|</span> <span class="n">sign_ups</span> <span class="o">|</span>
<span class="o">|------------|----------|</span>
<span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="o">|</span> <span class="mi">10</span>       <span class="o">|</span>
<span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span> <span class="o">|</span> <span class="mi">20</span>       <span class="o">|</span>
<span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span> <span class="o">|</span> <span class="mi">50</span>       <span class="o">|</span>
<span class="o">|</span> <span class="o">...</span>        <span class="o">|</span> <span class="o">...</span>      <span class="o">|</span>
<span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">01</span> <span class="o">|</span> <span class="mi">35</span>       <span class="o">|</span>
</pre></div>
</div>
<p><strong>Task</strong>: Write a query to get 7-day rolling (preceding) average of daily sign ups.</p>
<hr class="docutils" />
<p><em><strong>Solution:</strong></em></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> 
  <span class="n">a</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> 
  <span class="n">AVG</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">sign_ups</span><span class="p">)</span> <span class="n">average_sign_ups</span> 
<span class="n">FROM</span> 
  <span class="n">signups</span> <span class="n">a</span> 
<span class="n">JOIN</span> 
  <span class="n">signups</span> <span class="n">b</span> <span class="n">ON</span> <span class="n">a</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;=</span> <span class="n">b</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">interval</span> <span class="s1">&#39;6 days&#39;</span> <span class="n">AND</span> <span class="n">a</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="n">b</span><span class="o">.</span><span class="n">date</span>
<span class="n">GROUP</span> <span class="n">BY</span> 
  <span class="n">a</span><span class="o">.</span><span class="n">date</span>
</pre></div>
</div>
</div>
<div class="section" id="multiple-join-conditions">
<h2>6: Multiple Join Conditions<a class="headerlink" href="#multiple-join-conditions" title="Permalink to this headline">¶</a></h2>
<p><strong>Acknowledgement:</strong> This problem was inspired by Sisense’s <a class="reference external" href="https://www.sisense.com/blog/analyzing-your-email-with-sql/">“Analyzing Your Email with SQL”</a> blog post</p>
<p><strong>Context:</strong> Say we have a table <code class="docutils literal notranslate"><span class="pre">emails</span></code> that includes emails sent to and from <a class="reference external" href="mailto:zach&#37;&#52;&#48;g&#46;com"><code class="docutils literal notranslate"><span class="pre">zach&#64;g.com</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">|</span> <span class="nb">id</span> <span class="o">|</span> <span class="n">subject</span>  <span class="o">|</span> <span class="kn">from</span>         <span class="o">|</span> <span class="n">to</span>           <span class="o">|</span> <span class="n">timestamp</span>           <span class="o">|</span>
<span class="o">|----|----------|--------------|--------------|---------------------|</span>
<span class="o">|</span> <span class="mi">1</span>  <span class="o">|</span> <span class="n">Yosemite</span> <span class="o">|</span> <span class="n">zach</span><span class="nd">@g</span><span class="o">.</span><span class="n">com</span>   <span class="o">|</span> <span class="n">thomas</span><span class="nd">@g</span><span class="o">.</span><span class="n">com</span> <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span> <span class="mi">12</span><span class="p">:</span><span class="mi">45</span><span class="p">:</span><span class="mi">03</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">2</span>  <span class="o">|</span> <span class="n">Big</span> <span class="n">Sur</span>  <span class="o">|</span> <span class="n">sarah</span><span class="nd">@g</span><span class="o">.</span><span class="n">com</span>  <span class="o">|</span> <span class="n">thomas</span><span class="nd">@g</span><span class="o">.</span><span class="n">com</span> <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span> <span class="mi">16</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">01</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">3</span>  <span class="o">|</span> <span class="n">Yosemite</span> <span class="o">|</span> <span class="n">thomas</span><span class="nd">@g</span><span class="o">.</span><span class="n">com</span> <span class="o">|</span> <span class="n">zach</span><span class="nd">@g</span><span class="o">.</span><span class="n">com</span>   <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span> <span class="mi">16</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">04</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">4</span>  <span class="o">|</span> <span class="n">Running</span>  <span class="o">|</span> <span class="n">jill</span><span class="nd">@g</span><span class="o">.</span><span class="n">com</span>   <span class="o">|</span> <span class="n">zach</span><span class="nd">@g</span><span class="o">.</span><span class="n">com</span>   <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span> <span class="mi">08</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="mi">45</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">5</span>  <span class="o">|</span> <span class="n">Yosemite</span> <span class="o">|</span> <span class="n">zach</span><span class="nd">@g</span><span class="o">.</span><span class="n">com</span>   <span class="o">|</span> <span class="n">thomas</span><span class="nd">@g</span><span class="o">.</span><span class="n">com</span> <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span> <span class="mi">14</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="mi">01</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">6</span>  <span class="o">|</span> <span class="n">Yosemite</span> <span class="o">|</span> <span class="n">thomas</span><span class="nd">@g</span><span class="o">.</span><span class="n">com</span> <span class="o">|</span> <span class="n">zach</span><span class="nd">@g</span><span class="o">.</span><span class="n">com</span>   <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span> <span class="mi">15</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">05</span> <span class="o">|</span>
<span class="o">|</span> <span class="o">..</span> <span class="o">|</span> <span class="o">..</span>       <span class="o">|</span> <span class="o">..</span>           <span class="o">|</span> <span class="o">..</span>           <span class="o">|</span> <span class="o">..</span>                  <span class="o">|</span>
</pre></div>
</div>
<p>**Task: **Write a query to get the response time per email (<code class="docutils literal notranslate"><span class="pre">id</span></code>) sent to <code class="docutils literal notranslate"><span class="pre">zach&#64;g.com</span></code> . Do not include <code class="docutils literal notranslate"><span class="pre">id</span></code>s that did not receive a response from <a class="reference external" href="mailto:zach&#37;&#52;&#48;g&#46;com">zach<span>&#64;</span>g<span>&#46;</span>com</a>. Assume each email thread has a unique subject. Keep in mind a thread may have multiple responses back-and-forth between <a class="reference external" href="mailto:zach&#37;&#52;&#48;g&#46;com">zach<span>&#64;</span>g<span>&#46;</span>com</a> and another email address.</p>
<hr class="docutils" />
<p><em><strong>Solution:</strong></em></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> 
    <span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> 
    <span class="n">MIN</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span> <span class="o">-</span> <span class="n">a</span><span class="o">.</span><span class="n">timestamp</span> <span class="k">as</span> <span class="n">time_to_respond</span> 
<span class="n">FROM</span> 
    <span class="n">emails</span> <span class="n">a</span> 
<span class="n">JOIN</span>
    <span class="n">emails</span> <span class="n">b</span> 
        <span class="n">ON</span> 
            <span class="n">b</span><span class="o">.</span><span class="n">subject</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">subject</span> 
        <span class="n">AND</span> 
            <span class="n">a</span><span class="o">.</span><span class="n">to</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="kn">from</span>
        <span class="nn">AND</span> 
            <span class="n">a</span><span class="o">.</span><span class="kn">from</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">to</span> 
        <span class="n">AND</span> 
            <span class="n">a</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">.</span><span class="n">timestamp</span> 
 <span class="n">WHERE</span> 
    <span class="n">a</span><span class="o">.</span><span class="n">to</span> <span class="o">=</span> <span class="s1">&#39;zach@g.com&#39;</span> 
 <span class="n">GROUP</span> <span class="n">BY</span> 
    <span class="n">a</span><span class="o">.</span><span class="n">id</span> 
</pre></div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="window-function-practice-problems">
<h1>Window Function Practice Problems<a class="headerlink" href="#window-function-practice-problems" title="Permalink to this headline">¶</a></h1>
<div class="section" id="get-the-id-with-the-highest-value">
<h2>1: Get the ID with the highest value<a class="headerlink" href="#get-the-id-with-the-highest-value" title="Permalink to this headline">¶</a></h2>
<p><strong>Context:</strong> Say we have a table <code class="docutils literal notranslate"><span class="pre">salaries</span></code> with data on employee salary and department in the following format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">depname</span>  <span class="o">|</span> <span class="n">empno</span> <span class="o">|</span> <span class="n">salary</span> <span class="o">|</span>     
<span class="o">-----------+-------+--------+</span>
 <span class="n">develop</span>   <span class="o">|</span>    <span class="mi">11</span> <span class="o">|</span>   <span class="mi">5200</span> <span class="o">|</span> 
 <span class="n">develop</span>   <span class="o">|</span>     <span class="mi">7</span> <span class="o">|</span>   <span class="mi">4200</span> <span class="o">|</span> 
 <span class="n">develop</span>   <span class="o">|</span>     <span class="mi">9</span> <span class="o">|</span>   <span class="mi">4500</span> <span class="o">|</span> 
 <span class="n">develop</span>   <span class="o">|</span>     <span class="mi">8</span> <span class="o">|</span>   <span class="mi">6000</span> <span class="o">|</span> 
 <span class="n">develop</span>   <span class="o">|</span>    <span class="mi">10</span> <span class="o">|</span>   <span class="mi">5200</span> <span class="o">|</span> 
 <span class="n">personnel</span> <span class="o">|</span>     <span class="mi">5</span> <span class="o">|</span>   <span class="mi">3500</span> <span class="o">|</span> 
 <span class="n">personnel</span> <span class="o">|</span>     <span class="mi">2</span> <span class="o">|</span>   <span class="mi">3900</span> <span class="o">|</span> 
 <span class="n">sales</span>     <span class="o">|</span>     <span class="mi">3</span> <span class="o">|</span>   <span class="mi">4800</span> <span class="o">|</span> 
 <span class="n">sales</span>     <span class="o">|</span>     <span class="mi">1</span> <span class="o">|</span>   <span class="mi">5000</span> <span class="o">|</span> 
 <span class="n">sales</span>     <span class="o">|</span>     <span class="mi">4</span> <span class="o">|</span>   <span class="mi">4800</span> <span class="o">|</span> 
</pre></div>
</div>
<p><strong>Task</strong>: Write a query to get the <code class="docutils literal notranslate"><span class="pre">empno</span></code> with the highest salary. Make sure your solution can handle ties!</p>
<hr class="docutils" />
<p><em><strong>Solution:</strong></em></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>WITH max_salary AS (
    SELECT 
        MAX(salary) max_salary
    FROM 
        `salaries
    )
SELECT 
    s.empno
FROM 
    `salaries s
JOIN 
    max_salary ms ON s.salary = ms.max_salary ``
</pre></div>
</div>
<p>Alternate solution using <code class="docutils literal notranslate"><span class="pre">RANK()</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">WITH</span> <span class="n">sal_rank</span> <span class="n">AS</span> 
  <span class="p">(</span><span class="n">SELECT</span> 
    <span class="n">empno</span><span class="p">,</span> 
    <span class="n">RANK</span><span class="p">()</span> <span class="n">OVER</span><span class="p">(</span><span class="n">ORDER</span> <span class="n">BY</span> <span class="n">salary</span> <span class="n">DESC</span><span class="p">)</span> <span class="n">rnk</span>
  <span class="n">FROM</span> 
    <span class="n">salaries</span><span class="p">)</span>
<span class="n">SELECT</span> 
  <span class="n">empno</span>
<span class="n">FROM</span>
  <span class="n">sal_rank</span>
<span class="n">WHERE</span> 
  <span class="n">rnk</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="average-and-rank-with-a-window-function-multi-part">
<h2>2: Average and rank with a window function (multi-part)<a class="headerlink" href="#average-and-rank-with-a-window-function-multi-part" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id1">
<h3>Part 1:<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p><strong>Context</strong>: Say we have a table <code class="docutils literal notranslate"><span class="pre">salaries</span></code> in the format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">depname</span>  <span class="o">|</span> <span class="n">empno</span> <span class="o">|</span> <span class="n">salary</span> <span class="o">|</span>     
<span class="o">-----------+-------+--------+</span>
 <span class="n">develop</span>   <span class="o">|</span>    <span class="mi">11</span> <span class="o">|</span>   <span class="mi">5200</span> <span class="o">|</span> 
 <span class="n">develop</span>   <span class="o">|</span>     <span class="mi">7</span> <span class="o">|</span>   <span class="mi">4200</span> <span class="o">|</span> 
 <span class="n">develop</span>   <span class="o">|</span>     <span class="mi">9</span> <span class="o">|</span>   <span class="mi">4500</span> <span class="o">|</span> 
 <span class="n">develop</span>   <span class="o">|</span>     <span class="mi">8</span> <span class="o">|</span>   <span class="mi">6000</span> <span class="o">|</span> 
 <span class="n">develop</span>   <span class="o">|</span>    <span class="mi">10</span> <span class="o">|</span>   <span class="mi">5200</span> <span class="o">|</span> 
 <span class="n">personnel</span> <span class="o">|</span>     <span class="mi">5</span> <span class="o">|</span>   <span class="mi">3500</span> <span class="o">|</span> 
 <span class="n">personnel</span> <span class="o">|</span>     <span class="mi">2</span> <span class="o">|</span>   <span class="mi">3900</span> <span class="o">|</span> 
 <span class="n">sales</span>     <span class="o">|</span>     <span class="mi">3</span> <span class="o">|</span>   <span class="mi">4800</span> <span class="o">|</span> 
 <span class="n">sales</span>     <span class="o">|</span>     <span class="mi">1</span> <span class="o">|</span>   <span class="mi">5000</span> <span class="o">|</span> 
 <span class="n">sales</span>     <span class="o">|</span>     <span class="mi">4</span> <span class="o">|</span>   <span class="mi">4800</span> <span class="o">|</span> 
</pre></div>
</div>
<p><strong>Task:</strong> Write a query that returns the same table, but with a new column that has average salary per <code class="docutils literal notranslate"><span class="pre">depname</span></code>. We would expect a table in the form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">depname</span>  <span class="o">|</span> <span class="n">empno</span> <span class="o">|</span> <span class="n">salary</span> <span class="o">|</span> <span class="n">avg_salary</span> <span class="o">|</span>     
<span class="o">-----------+-------+--------+------------+</span>
 <span class="n">develop</span>   <span class="o">|</span>    <span class="mi">11</span> <span class="o">|</span>   <span class="mi">5200</span> <span class="o">|</span>       <span class="mi">5020</span> <span class="o">|</span>
 <span class="n">develop</span>   <span class="o">|</span>     <span class="mi">7</span> <span class="o">|</span>   <span class="mi">4200</span> <span class="o">|</span>       <span class="mi">5020</span> <span class="o">|</span> 
 <span class="n">develop</span>   <span class="o">|</span>     <span class="mi">9</span> <span class="o">|</span>   <span class="mi">4500</span> <span class="o">|</span>       <span class="mi">5020</span> <span class="o">|</span>
 <span class="n">develop</span>   <span class="o">|</span>     <span class="mi">8</span> <span class="o">|</span>   <span class="mi">6000</span> <span class="o">|</span>       <span class="mi">5020</span> <span class="o">|</span> 
 <span class="n">develop</span>   <span class="o">|</span>    <span class="mi">10</span> <span class="o">|</span>   <span class="mi">5200</span> <span class="o">|</span>       <span class="mi">5020</span> <span class="o">|</span> 
 <span class="n">personnel</span> <span class="o">|</span>     <span class="mi">5</span> <span class="o">|</span>   <span class="mi">3500</span> <span class="o">|</span>       <span class="mi">3700</span> <span class="o">|</span>
 <span class="n">personnel</span> <span class="o">|</span>     <span class="mi">2</span> <span class="o">|</span>   <span class="mi">3900</span> <span class="o">|</span>       <span class="mi">3700</span> <span class="o">|</span>
 <span class="n">sales</span>     <span class="o">|</span>     <span class="mi">3</span> <span class="o">|</span>   <span class="mi">4800</span> <span class="o">|</span>       <span class="mi">4867</span> <span class="o">|</span> 
 <span class="n">sales</span>     <span class="o">|</span>     <span class="mi">1</span> <span class="o">|</span>   <span class="mi">5000</span> <span class="o">|</span>       <span class="mi">4867</span> <span class="o">|</span> 
 <span class="n">sales</span>     <span class="o">|</span>     <span class="mi">4</span> <span class="o">|</span>   <span class="mi">4800</span> <span class="o">|</span>       <span class="mi">4867</span> <span class="o">|</span>
</pre></div>
</div>
<hr class="docutils" />
<p><em><strong>Solution:</strong></em></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> 
    <span class="o">*</span><span class="p">,</span> 
    <span class="o">/*</span>
    <span class="o">*</span> <span class="n">AVG</span><span class="p">()</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">Postgres</span> <span class="n">command</span><span class="p">,</span> <span class="n">but</span> <span class="n">other</span> <span class="n">SQL</span> <span class="n">flavors</span> <span class="n">like</span> <span class="n">BigQuery</span> <span class="n">use</span> 
    <span class="o">*</span> <span class="n">AVERAGE</span><span class="p">()</span>
    <span class="o">*/</span> 
    <span class="n">ROUND</span><span class="p">(</span><span class="n">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="n">BY</span> <span class="n">depname</span><span class="p">)</span> <span class="n">avg_salary</span>
<span class="n">FROM</span>
    <span class="n">salaries</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h3>Part 2:<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p><strong>Task:</strong> Write a query that adds a column with the rank of each employee based on their salary within their department, where the employee with the highest salary gets the rank of <code class="docutils literal notranslate"><span class="pre">1</span></code>. We would expect a table in the form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">depname</span>  <span class="o">|</span> <span class="n">empno</span> <span class="o">|</span> <span class="n">salary</span> <span class="o">|</span> <span class="n">salary_rank</span> <span class="o">|</span>     
<span class="o">-----------+-------+--------+-------------+</span>
 <span class="n">develop</span>   <span class="o">|</span>    <span class="mi">11</span> <span class="o">|</span>   <span class="mi">5200</span> <span class="o">|</span>           <span class="mi">2</span> <span class="o">|</span>
 <span class="n">develop</span>   <span class="o">|</span>     <span class="mi">7</span> <span class="o">|</span>   <span class="mi">4200</span> <span class="o">|</span>           <span class="mi">5</span> <span class="o">|</span> 
 <span class="n">develop</span>   <span class="o">|</span>     <span class="mi">9</span> <span class="o">|</span>   <span class="mi">4500</span> <span class="o">|</span>           <span class="mi">4</span> <span class="o">|</span>
 <span class="n">develop</span>   <span class="o">|</span>     <span class="mi">8</span> <span class="o">|</span>   <span class="mi">6000</span> <span class="o">|</span>           <span class="mi">1</span> <span class="o">|</span> 
 <span class="n">develop</span>   <span class="o">|</span>    <span class="mi">10</span> <span class="o">|</span>   <span class="mi">5200</span> <span class="o">|</span>           <span class="mi">2</span> <span class="o">|</span> 
 <span class="n">personnel</span> <span class="o">|</span>     <span class="mi">5</span> <span class="o">|</span>   <span class="mi">3500</span> <span class="o">|</span>           <span class="mi">2</span> <span class="o">|</span>
 <span class="n">personnel</span> <span class="o">|</span>     <span class="mi">2</span> <span class="o">|</span>   <span class="mi">3900</span> <span class="o">|</span>           <span class="mi">1</span> <span class="o">|</span>
 <span class="n">sales</span>     <span class="o">|</span>     <span class="mi">3</span> <span class="o">|</span>   <span class="mi">4800</span> <span class="o">|</span>           <span class="mi">2</span> <span class="o">|</span> 
 <span class="n">sales</span>     <span class="o">|</span>     <span class="mi">1</span> <span class="o">|</span>   <span class="mi">5000</span> <span class="o">|</span>           <span class="mi">1</span> <span class="o">|</span> 
 <span class="n">sales</span>     <span class="o">|</span>     <span class="mi">4</span> <span class="o">|</span>   <span class="mi">4800</span> <span class="o">|</span>           <span class="mi">2</span> <span class="o">|</span> 
</pre></div>
</div>
<hr class="docutils" />
<p><em><strong>Solution:</strong></em></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> 
    <span class="o">*</span><span class="p">,</span> 
    <span class="n">RANK</span><span class="p">()</span> <span class="n">OVER</span><span class="p">(</span><span class="n">PARTITION</span> <span class="n">BY</span> <span class="n">depname</span> <span class="n">ORDER</span> <span class="n">BY</span> <span class="n">salary</span> <span class="n">DESC</span><span class="p">)</span> <span class="n">salary_rank</span>
 <span class="n">FROM</span>  
    <span class="n">salaries</span> 
</pre></div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="other-medium-hard-sql-practice-problems">
<h1>Other Medium/Hard SQL Practice Problems<a class="headerlink" href="#other-medium-hard-sql-practice-problems" title="Permalink to this headline">¶</a></h1>
<div class="section" id="histograms">
<h2>1: Histograms<a class="headerlink" href="#histograms" title="Permalink to this headline">¶</a></h2>
<p><strong>Context:</strong> Say we have a table <code class="docutils literal notranslate"><span class="pre">sessions</span></code> where each row is a video streaming session with length in seconds:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">|</span> <span class="n">session_id</span> <span class="o">|</span> <span class="n">length_seconds</span> <span class="o">|</span>
<span class="o">|------------|----------------|</span>
<span class="o">|</span> <span class="mi">1</span>          <span class="o">|</span> <span class="mi">23</span>             <span class="o">|</span>
<span class="o">|</span> <span class="mi">2</span>          <span class="o">|</span> <span class="mi">453</span>            <span class="o">|</span>
<span class="o">|</span> <span class="mi">3</span>          <span class="o">|</span> <span class="mi">27</span>             <span class="o">|</span>
<span class="o">|</span> <span class="o">..</span>         <span class="o">|</span> <span class="o">..</span>             <span class="o">|</span>
</pre></div>
</div>
<p><strong>Task:</strong> Write a query to count the number of sessions that fall into bands of size 5, i.e. for the above snippet, produce something akin to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">|</span> <span class="n">bucket</span>  <span class="o">|</span> <span class="n">count</span> <span class="o">|</span>
<span class="o">|---------|-------|</span>
<span class="o">|</span> <span class="mi">20</span><span class="o">-</span><span class="mi">25</span>   <span class="o">|</span> <span class="mi">2</span>     <span class="o">|</span>
<span class="o">|</span> <span class="mi">450</span><span class="o">-</span><span class="mi">455</span> <span class="o">|</span> <span class="mi">1</span>     <span class="o">|</span>
</pre></div>
</div>
<p>Get complete credit for the proper string labels (“5-10”, etc.) but near complete credit for something that is communicable as the bin.</p>
<hr class="docutils" />
<p><em><strong>Solution:</strong></em></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>WITH bin_label AS 
(SELECT 
    session_id, 
    FLOOR(length_seconds/5) as bin_label 
 FROM
    sessions 
 )
 SELECT 
    `CONCATENTATE(STR(bin_label*5), &#39;-&#39;, STR(`bin_label*5+5)) bucket, 
    COUNT(DISTINCT session_id) count ``
 GROUP BY 
    bin_label
 ORDER BY 
    `bin_label ASC `
</pre></div>
</div>
</div>
<div class="section" id="cross-join-multi-part">
<h2>2: CROSS JOIN (multi-part)<a class="headerlink" href="#cross-join-multi-part" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id3">
<h3>Part 1:<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p><strong>Context:</strong> Say we have a table <code class="docutils literal notranslate"><span class="pre">state_streams</span></code> where each row is a state and the total number of hours of streaming from a video hosting service:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">|</span> <span class="n">state</span> <span class="o">|</span> <span class="n">total_streams</span> <span class="o">|</span>
<span class="o">|-------|---------------|</span>
<span class="o">|</span> <span class="n">NC</span>    <span class="o">|</span> <span class="mi">34569</span>         <span class="o">|</span>
<span class="o">|</span> <span class="n">SC</span>    <span class="o">|</span> <span class="mi">33999</span>         <span class="o">|</span>
<span class="o">|</span> <span class="n">CA</span>    <span class="o">|</span> <span class="mi">98324</span>         <span class="o">|</span>
<span class="o">|</span> <span class="n">MA</span>    <span class="o">|</span> <span class="mi">19345</span>         <span class="o">|</span>
<span class="o">|</span> <span class="o">..</span>    <span class="o">|</span> <span class="o">..</span>            <span class="o">|</span>
</pre></div>
</div>
<p>(In reality these kinds of aggregate tables would normally have a date column, but we’ll exclude that component in this problem)</p>
<p><strong>Task:</strong> Write a query to get the pairs of states with total streaming amounts within 1000 of each other. For the snippet above, we would want to see something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">|</span> <span class="n">state_a</span> <span class="o">|</span> <span class="n">state_b</span> <span class="o">|</span>
<span class="o">|---------|---------|</span>
<span class="o">|</span> <span class="n">NC</span>      <span class="o">|</span> <span class="n">SC</span>      <span class="o">|</span>
<span class="o">|</span> <span class="n">SC</span>      <span class="o">|</span> <span class="n">NC</span>      <span class="o">|</span>
</pre></div>
</div>
<hr class="docutils" />
<p><em><strong>Solution:</strong></em></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span>
    <span class="n">a</span><span class="o">.</span><span class="n">state</span> <span class="k">as</span> <span class="n">state_a</span><span class="p">,</span> 
    <span class="n">b</span><span class="o">.</span><span class="n">state</span> <span class="k">as</span> <span class="n">state_b</span> 
 <span class="n">FROM</span>   
    <span class="n">state_streams</span> <span class="n">a</span>
 <span class="n">CROSS</span> <span class="n">JOIN</span> 
    <span class="n">state_streams</span> <span class="n">b</span> 
 <span class="n">WHERE</span> 
    <span class="n">ABS</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">total_streams</span> <span class="o">-</span> <span class="n">b</span><span class="o">.</span><span class="n">total_streams</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1000</span>
    <span class="n">AND</span> 
    <span class="n">a</span><span class="o">.</span><span class="n">state</span> <span class="o">&lt;&gt;</span> <span class="n">b</span><span class="o">.</span><span class="n">state</span> 
</pre></div>
</div>
<p>FYI, <code class="docutils literal notranslate"><span class="pre">CROSS</span> <span class="pre">JOIN</span></code> s can also be written without explicitly specifying a join:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span>
    <span class="n">a</span><span class="o">.</span><span class="n">state</span> <span class="k">as</span> <span class="n">state_a</span><span class="p">,</span> 
    <span class="n">b</span><span class="o">.</span><span class="n">state</span> <span class="k">as</span> <span class="n">state_b</span> 
 <span class="n">FROM</span>   
    <span class="n">state_streams</span> <span class="n">a</span><span class="p">,</span> <span class="n">state_streams</span> <span class="n">b</span> 
 <span class="n">WHERE</span> 
    <span class="n">ABS</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">total_streams</span> <span class="o">-</span> <span class="n">b</span><span class="o">.</span><span class="n">total_streams</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1000</span>
    <span class="n">AND</span> 
    <span class="n">a</span><span class="o">.</span><span class="n">state</span> <span class="o">&lt;&gt;</span> <span class="n">b</span><span class="o">.</span><span class="n">state</span> 
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h3>Part 2:<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p><strong>Note:</strong> This question is considered more of a bonus problem than an actual SQL pattern. Feel free to skip it!</p>
<p><strong>Task:</strong> How could you modify the SQL from the solution to Part 1 of this question so that duplicates are removed? For example, if we used the sample table from Part 1, the pair <code class="docutils literal notranslate"><span class="pre">NC</span></code> and <code class="docutils literal notranslate"><span class="pre">SC</span></code> should only appear in one row instead of two.</p>
<hr class="docutils" />
<p><strong>Solution:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span>
    <span class="n">a</span><span class="o">.</span><span class="n">state</span> <span class="k">as</span> <span class="n">state_a</span><span class="p">,</span> 
    <span class="n">b</span><span class="o">.</span><span class="n">state</span> <span class="k">as</span> <span class="n">state_b</span> 
 <span class="n">FROM</span>   
    <span class="n">state_streams</span> <span class="n">a</span><span class="p">,</span> <span class="n">state_streams</span> <span class="n">b</span> 
 <span class="n">WHERE</span> 
    <span class="n">ABS</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">total_streams</span> <span class="o">-</span> <span class="n">b</span><span class="o">.</span><span class="n">total_streams</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1000</span>
    <span class="n">AND</span> 
    <span class="n">a</span><span class="o">.</span><span class="n">state</span> <span class="o">&gt;</span> <span class="n">b</span><span class="o">.</span><span class="n">state</span> 
</pre></div>
</div>
</div>
</div>
<div class="section" id="advancing-counting">
<h2>3: Advancing Counting<a class="headerlink" href="#advancing-counting" title="Permalink to this headline">¶</a></h2>
<p><strong>Acknowledgement:</strong> This question is adapted from <a class="reference external" href="https://stackoverflow.com/questions/54488894/using-case-to-properly-count-items-with-if-else-logic-in-sql">this Stack Overflow question</a> by me (zthomas.nc)</p>
<p><strong>Note:</strong> this question is probably more complex than the kind you would encounter in an interview. Consider it a challenge problem, or feel free to skip it!</p>
<p><strong>Context:</strong> Say I have a table <code class="docutils literal notranslate"><span class="pre">table</span></code> in the following form, where a <code class="docutils literal notranslate"><span class="pre">user</span></code> can be mapped to multiple values of <code class="docutils literal notranslate"><span class="pre">class</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>| user | class |
|------|-------|
| 1    | a     |
| 1    | b     |
| 1    | b     |
| 2    | b     |
| 3    | a     |
</pre></div>
</div>
<p><strong>Task:</strong> Assume there are only two possible values for <code class="docutils literal notranslate"><span class="pre">class</span></code>. Write a query to count the number of users in each class such that any user who has label <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> gets sorted into <code class="docutils literal notranslate"><span class="pre">b</span></code>, any user with just <code class="docutils literal notranslate"><span class="pre">a</span></code> gets sorted into <code class="docutils literal notranslate"><span class="pre">a</span></code> and any user with just <code class="docutils literal notranslate"><span class="pre">b</span></code> gets into <code class="docutils literal notranslate"><span class="pre">b</span></code>.</p>
<p>For <code class="docutils literal notranslate"><span class="pre">table</span></code> that would result in the following table:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>| class | count |
|-------|-------|
| a     | 1     |
 | b     | 2     |
</pre></div>
</div>
<hr class="docutils" />
<p><strong>Solution:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>WITH usr_b_sum AS 
(
    SELECT 
        user, 
        SUM(CASE WHEN class = &#39;b&#39; THEN 1 ELSE 0 END) num_b
    FROM 
        table
    GROUP BY 
        user
), 

usr_class_label AS 
(
    SELECT 
        user, 
        CASE WHEN num_b &gt; 0 THEN &#39;b&#39; ELSE &#39;a&#39; END class 
    FROM 
        usr_b_sum
)

SELECT 
    class, 
    COUNT(DISTINCT user) count 
FROM
    usr_class_label
GROUP BY 
    class 
ORDER BY 
    class ASC

    
</pre></div>
</div>
<p>Alternate solution: Using <code class="docutils literal notranslate"><span class="pre">SELECT</span></code>s in the <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> statement and <code class="docutils literal notranslate"><span class="pre">UNION</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SELECT 
    &quot;a&quot; class,
    COUNT(DISTINCT user_id) - 
        (SELECT COUNT(DISTINCT user_id) FROM table WHERE class = &#39;b&#39;) count 
UNION
SELECT 
    &quot;b&quot; class,
    (SELECT COUNT(DISTINCT user_id) FROM table WHERE class = &#39;b&#39;) count 
</pre></div>
</div>
<p>Alternate solution: Since the problem as stated didn’t ask for generalizable solution, you can leverage the fact that <code class="docutils literal notranslate"><span class="pre">b</span></code> &gt; <code class="docutils literal notranslate"><span class="pre">a</span></code> to produce this straightforward solution:</p>
<p><strong>Acknowledgement</strong>: Thanks to Karan Gadiya for contributing this solution. Thanks, KG!</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">WITH</span> <span class="n">max_class</span> <span class="n">AS</span> <span class="p">(</span>
    <span class="n">SELECT</span>
        <span class="n">user</span><span class="p">,</span> 
        <span class="n">MAX</span><span class="p">(</span><span class="n">class</span><span class="p">)</span> <span class="k">as</span> <span class="k">class</span> 
    <span class="nc">FROM</span> 
        <span class="n">table</span> 
    <span class="n">GROUP</span> <span class="n">BY</span> 
        <span class="n">user</span>
<span class="p">)</span>

<span class="n">SELECT</span> 
    <span class="n">class</span><span class="p">,</span> 
    <span class="n">COUNT</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="n">FROM</span>
    <span class="n">max_class</span>
<span class="n">GROUP</span> <span class="n">BY</span> 
    <span class="k">class</span>    
</pre></div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./CS"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>
    <script type="text/javascript">
        function init() {
            WaveDrom.ProcessAll();
        }
        window.onload = init;
    </script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="Note-HTML%20basics.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">HTML Basics</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="Note-Learning%20React.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Learning React</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Ming Yang<br/>
    
        &copy; Copyright 2022.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>